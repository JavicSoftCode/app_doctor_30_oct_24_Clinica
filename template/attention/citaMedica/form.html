{#{% extends 'components/base.html' %}#}
{#{% block content %}#}
{#    {% load static %}#}
{#    <div class="container-fluid">#}
{#        <div class="row">#}
{#            <div class="col-md-12 col-lg-12 px-md-4 main-content">#}
{#                <!-- Mensajes de ERRORES -->#}
{#                {% include 'includes/message_error_form.html' %}#}
{#                <div class="card mb-4">#}
{#                    <div class="card-body">#}
{#                        <form method="POST" enctype="multipart/form-data" class="row">#}
{#                            {% csrf_token %}#}
{##}
{#                            <h3 class="card-title mb-0 text-primary-emphasis fw-bold">{{ title1 }}</h3>#}
{##}
{#                            <div class="col-md-6 mt-3">#}
{#                                <div class="form-group">#}
{#                                    <label for="{{ form.paciente.id_for_label }}"#}
{#                                           class="form-label fw-bold">{{ form.paciente.label }}</label>#}
{#                                    {{ form.paciente }}#}
{#                                    {{ form.paciente.errors }}#}
{#                                </div>#}
{##}
{#                                <div class="form-group">#}
{#                                    <label for="{{ form.fecha.id_for_label }}"#}
{#                                           class="form-label fw-bold">{{ form.fecha.label }}</label>#}
{#                                    {{ form.fecha }}#}
{#                                    {{ form.fecha.errors }}#}
{#                                </div>#}
{#                            </div>#}
{##}
{#                            <div class="col-md-6 mt-3">#}
{#                                <div class="form-group">#}
{#                                    <label for="{{ form.hora_cita.id_for_label }}"#}
{#                                           class="form-label fw-bold">{{ form.hora_cita.label }}</label>#}
{#                                    {{ form.hora_cita }}#}
{#                                    {{ form.hora_cita.errors }}#}
{#                                </div>#}
{##}
{#                                <div class="form-group">#}
{#                                    <label for="{{ form.estado.id_for_label }}"#}
{#                                           class="form-label fw-bold">{{ form.estado.label }}</label>#}
{#                                    {{ form.estado }}#}
{#                                    {{ form.estado.errors }}#}
{#                                </div>#}
{##}
{#                                <div class="d-flex justify-content-end mt-4">#}
{#                                    <button class="btn me-2 grabar" type="submit" style="background-color: #3B3BBA; color: white">{{ grabar }}</button>#}
{#                                    <a class="btn btn-secondary cancelar" href="{{ back_url }}">Cancelar</a>#}
{#                                </div>#}
{#                            </div>#}
{#                        </form>#}
{#                    </div>#}
{#                </div>#}
{#            </div>#}
{#        </div>#}
{#    </div>#}
{#{% endblock content %}#}

{#{% extends 'components/base.html' %}#}
{#{% block content %}#}
{#{% load static %}#}
{#<div class="container-fluid">#}
{#    <div class="row">#}
{#        <div class="col-md-12 col-lg-12 px-md-4 main-content">#}
{#            {% include 'includes/message_error_form.html' %}#}
{#            <div class="card mb-4">#}
{#                <div class="card-body">#}
{#                    <form method="POST" enctype="multipart/form-data" class="row" id="citaMedicaForm">#}
{#                        {% csrf_token %}#}
{#                        <h3 class="card-title mb-0 text-primary-emphasis fw-bold">{{ title1 }}</h3>#}
{##}
{#                        <div class="col-md-6 mt-3">#}
{#                            <div class="form-group">#}
{#                                <label for="{{ form.paciente.id_for_label }}" class="form-label fw-bold">{{ form.paciente.label }}</label>#}
{#                                {{ form.paciente }}#}
{#                                {{ form.paciente.errors }}#}
{#                            </div>#}
{##}
{#                            <div class="form-group">#}
{#                                <label for="{{ form.fecha.id_for_label }}" class="form-label fw-bold">{{ form.fecha.label }}</label>#}
{#                                {{ form.fecha }}#}
{#                                {{ form.fecha.errors }}#}
{#                            </div>#}
{#                        </div>#}
{##}
{#                        <div class="col-md-6 mt-3">#}
{#                            <div class="form-group">#}
{#                                <label for="{{ form.hora_cita.id_for_label }}" class="form-label fw-bold">{{ form.hora_cita.label }}</label>#}
{#                                {{ form.hora_cita }}#}
{#                                {{ form.hora_cita.errors }}#}
{#                            </div>#}
{##}
{#                            <div class="form-group">#}
{#                                <label for="{{ form.estado.id_for_label }}" class="form-label fw-bold">{{ form.estado.label }}</label>#}
{#                                {{ form.estado }}#}
{#                                {{ form.estado.errors }}#}
{#                            </div>#}
{#                        </div>#}
{##}
{#                        <!-- Calendario y Horarios -->#}
{#                        <div class="col-12 mt-4">#}
{#                            <div class="card">#}
{#                                <div class="card-header">#}
{#                                    <h5 class="mb-0">Horarios Disponibles</h5>#}
{#                                </div>#}
{#                                <div class="card-body">#}
{#                                    <div id="calendar"></div>#}
{#                                    <div class="mt-4">#}
{#                                        <h6>Horarios del día:</h6>#}
{#                                        <div id="timeSlots" class="d-flex flex-wrap gap-2"></div>#}
{#                                    </div>#}
{#                                </div>#}
{#                            </div>#}
{#                        </div>#}
{##}
{#                        <div class="col-12 d-flex justify-content-end mt-4">#}
{#                            <button class="btn me-2 grabar" type="submit" style="background-color: #3B3BBA; color: white">{{ grabar }}</button>#}
{#                            <a class="btn btn-secondary cancelar" href="{{ back_url }}">Cancelar</a>#}
{#                        </div>#}
{#                    </form>#}
{#                </div>#}
{#            </div>#}
{#        </div>#}
{#    </div>#}
{#</div>#}
{##}
{#{% block extra_js %}#}
{#<script>#}
{#document.addEventListener('DOMContentLoaded', function() {#}
{#    let doctorSchedule = {};#}
{#    let selectedDate = null;#}
{#    let selectedTime = null;#}
{##}
{#    // Función para cargar los horarios del doctor#}
{#    async function loadDoctorSchedule() {#}
{#        try {#}
{#            const response = await fetch('/api/doctor-schedule/'); // Ajusta la URL según tu API#}
{#            doctorSchedule = await response.json();#}
{#            initializeCalendar();#}
{#        } catch (error) {#}
{#            console.error('Error cargando horarios:', error);#}
{#        }#}
{#    }#}
{##}
{#    // Inicializar el calendario#}
{#    function initializeCalendar() {#}
{#        const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {#}
{#            initialView: 'dayGridMonth',#}
{#            selectable: true,#}
{#            locale: 'es',#}
{#            headerToolbar: {#}
{#                left: 'prev,next today',#}
{#                center: 'title',#}
{#                right: 'dayGridMonth'#}
{#            },#}
{#            dateClick: function(info) {#}
{#                handleDateSelection(info.date);#}
{#            },#}
{#            dayCellDidMount: function(info) {#}
{#                // Marcar días con horarios disponibles#}
{#                const dateStr = info.date.toISOString().split('T')[0];#}
{#                if (doctorSchedule[dateStr]) {#}
{#                    info.el.style.backgroundColor = '#e6f3ff';#}
{#                }#}
{#            }#}
{#        });#}
{#        calendar.render();#}
{#    }#}
{##}
{#    // Manejar la selección de fecha#}
{#    function handleDateSelection(date) {#}
{#        selectedDate = date.toISOString().split('T')[0];#}
{#        const timeSlots = doctorSchedule[selectedDate] || [];#}
{#        displayTimeSlots(timeSlots);#}
{##}
{#        // Actualizar el campo de fecha del formulario#}
{#        document.querySelector('[name="fecha"]').value = selectedDate;#}
{#    }#}
{##}
{#    // Mostrar horarios disponibles#}
{#    function displayTimeSlots(timeSlots) {#}
{#        const container = document.getElementById('timeSlots');#}
{#        container.innerHTML = '';#}
{##}
{#        timeSlots.forEach(slot => {#}
{#            const button = document.createElement('button');#}
{#            button.type = 'button';#}
{#            button.className = 'btn btn-outline-primary';#}
{#            button.textContent = slot;#}
{##}
{#            // Verificar si el horario ya está reservado#}
{#            checkTimeSlotAvailability(selectedDate, slot).then(isAvailable => {#}
{#                if (!isAvailable) {#}
{#                    button.className = 'btn btn-secondary';#}
{#                    button.disabled = true;#}
{#                }#}
{#            });#}
{##}
{#            button.onclick = () => selectTimeSlot(slot, button);#}
{#            container.appendChild(button);#}
{#        });#}
{#    }#}
{##}
{#    // Verificar disponibilidad del horario#}
{#    async function checkTimeSlotAvailability(date, time) {#}
{#        try {#}
{#            const response = await fetch(`/api/check-availability/?date=${date}&time=${time}`);#}
{#            const data = await response.json();#}
{#            return data.available;#}
{#        } catch (error) {#}
{#            console.error('Error verificando disponibilidad:', error);#}
{#            return false;#}
{#        }#}
{#    }#}
{##}
{#    // Seleccionar horario#}
{#    function selectTimeSlot(time, button) {#}
{#        // Limpiar selección previa#}
{#        document.querySelectorAll('#timeSlots button').forEach(btn => {#}
{#            btn.classList.remove('btn-success');#}
{#            btn.classList.add('btn-outline-primary');#}
{#        });#}
{##}
{#        // Marcar nueva selección#}
{#        button.classList.remove('btn-outline-primary');#}
{#        button.classList.add('btn-success');#}
{#        selectedTime = time;#}
{##}
{#        // Actualizar el campo de hora del formulario#}
{#        document.querySelector('[name="hora_cita"]').value = time;#}
{#    }#}
{##}
{#    // Validar formulario antes de enviar#}
{#    document.getElementById('citaMedicaForm').onsubmit = async function(e) {#}
{#        e.preventDefault();#}
{##}
{#        if (!selectedDate || !selectedTime) {#}
{#            alert('Por favor seleccione fecha y hora para la cita');#}
{#            return;#}
{#        }#}
{##}
{#        const isAvailable = await checkTimeSlotAvailability(selectedDate, selectedTime);#}
{#        if (!isAvailable) {#}
{#            alert('Este horario ya no está disponible. Por favor seleccione otro.');#}
{#            return;#}
{#        }#}
{##}
{#        this.submit();#}
{#    };#}
{##}
{#    // Cargar horarios al iniciar#}
{#    loadDoctorSchedule();#}
{#});#}
{#</script>#}
{#    <link href='https://cdn.jsdelivr.net/npm/@fullcalendar/core@4.4.0/main.min.css' rel='stylesheet' />#}
{#<link href='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@4.4.0/main.min.css' rel='stylesheet' />#}
{#<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@4.4.0/main.min.js'></script>#}
{#<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@4.4.0/main.min.js'></script>#}
{#{% endblock %}#}
{#{% endblock content %}#}

{% extends 'components/base.html' %}
{% load static %}

{% block content %}
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12 col-lg-12 px-md-4 main-content">
                <div class="card">

                    <div class="card-body">
                        <form method="POST" id="citaMedicaForm">
                            {% csrf_token %}
                            <h3 class="text-primary-emphasis mb-4 fw-bold">{{ title1 }}</h3>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.paciente.id_for_label }}"
                                               class="form-label">Paciente</label>
                                        {{ form.paciente }}
                                    </div>

                                    <div class="form-group mb-3">
                                        <label for="{{ form.fecha.id_for_label }}" class="form-label">Fecha</label>
                                        {{ form.fecha }}
                                    </div>

                                </div>

                                <div class="col-md-6">
                                                  <div class="form-group mb-3">
                                        <label for="{{ form.hora_cita.id_for_label }}" class="form-label">Hora</label>
                                        {{ form.hora_cita }}
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="{{ form.estado.id_for_label }}" class="form-label">Estado</label>
                                        {{ form.estado }}
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-12 d-flex justify-content-end">
                                    <button type="submit" class="btn btn-primary me-2">Guardar Cita Médica</button>
                                    <a href="{{ back_url }}" class="btn btn-secondary">Cancelar</a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
